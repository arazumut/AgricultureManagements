{% extends 'base.html' %}

{% block title %}{{ animal.tag_number }} Detayları{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Başlık ve Navigasyon -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">
            {% if animal.gender == 'M' %}
                <i class="fas fa-mars text-primary"></i>
            {% else %}
                <i class="fas fa-venus text-danger"></i>
            {% endif %}
            {{ animal.tag_number }}
            <span class="badge {% if animal.gender == 'M' %}bg-primary{% else %}bg-danger{% endif %}">{{ animal.get_gender_display }}</span>
        </h1>
        <div>
            <a href="{% url 'hayvan:animal_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Listeye Dön
            </a>
            <a href="{% url 'hayvan:animal_update' animal.pk %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Düzenle
            </a>
        </div>
    </div>

    <!-- Mesajlar -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Hayvan Bilgileri -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">Hayvan Bilgileri</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center mb-3">
                    {% if animal.image %}
                    <img src="{{ animal.image.url }}" alt="{{ animal.tag_number }}" class="img-fluid rounded mb-2" style="max-height: 200px;">
                    {% else %}
                    <div class="border rounded p-5 mb-2 bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="fas {% if animal.gender == 'M' %}fa-mars{% else %}fa-venus{% endif %} fa-3x text-secondary"></i>
                    </div>
                    {% endif %}
                    <div class="badge {% if animal.is_active %}bg-success{% else %}bg-secondary{% endif %} mb-2">
                        {{ animal.get_status }}
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Küpe No:</th>
                                    <td>{{ animal.tag_number }}</td>
                                </tr>
                                <tr>
                                    <th>Tür:</th>
                                    <td>{{ animal.animal_type }}</td>
                                </tr>
                                <tr>
                                    <th>Irk:</th>
                                    <td>{{ animal.breed }}</td>
                                </tr>
                                <tr>
                                    <th>Doğum Tarihi:</th>
                                    <td>{{ animal.birth_date }}</td>
                                </tr>
                                <tr>
                                    <th>Yaş:</th>
                                    <td>{{ animal.get_age }}</td>
                                </tr>
                                <tr>
                                    <th>Ağırlık:</th>
                                    <td>{% if animal.weight %}{{ animal.weight }} kg{% else %}-{% endif %}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Ana Küpe No:</th>
                                    <td>{% if animal.mother_tag_number %}{{ animal.mother_tag_number }}{% else %}-{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Baba Küpe No:</th>
                                    <td>{% if animal.father_tag_number %}{{ animal.father_tag_number }}{% else %}-{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Geliş Tarihi:</th>
                                    <td>{% if animal.arrival_date %}{{ animal.arrival_date }}{% else %}-{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Kaynak:</th>
                                    <td>{% if animal.source %}{{ animal.source }}{% else %}-{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Satın Alma Fiyatı:</th>
                                    <td>{% if animal.purchase_price %}{{ animal.purchase_price }} TL{% else %}-{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Eklenme Tarihi:</th>
                                    <td>{{ animal.created_at|date:"d.m.Y" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    {% if animal.notes %}
                    <div class="mt-3">
                        <h6>Notlar:</h6>
                        <p class="mb-0">{{ animal.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            <a href="{% url 'hayvan:animal_delete' animal.pk %}" class="btn btn-danger">
                <i class="fas fa-trash"></i> Sil
            </a>
        </div>
    </div>

    <!-- Sağlık Kayıtları -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Sağlık Kayıtları</h5>
            <a href="{% url 'hayvan:health_record_create' animal.pk %}" class="btn btn-sm btn-success">
                <i class="fas fa-plus"></i> Yeni Sağlık Kaydı
            </a>
        </div>
        <div class="card-body">
            {% if health_records %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>İşlem Tipi</th>
                            <th>Tanı/İşlem</th>
                            <th>Veteriner</th>
                            <th>Maliyet</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in health_records %}
                        <tr>
                            <td>{{ record.procedure_date }}</td>
                            <td>{{ record.get_procedure_type_display }}</td>
                            <td>{{ record.diagnosis|default:"-" }}</td>
                            <td>{{ record.veterinarian|default:"-" }}</td>
                            <td>{% if record.cost %}{{ record.cost }} TL{% else %}-{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted my-3">Henüz sağlık kaydı bulunmamaktadır.</p>
            {% endif %}
        </div>
    </div>

    <!-- Üreme Kayıtları (Sadece Dişi Hayvanlar İçin) -->
    {% if animal.gender == 'F' %}
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Üreme Kayıtları</h5>
            <a href="{% url 'hayvan:reproduction_record_create' animal.pk %}" class="btn btn-sm btn-success">
                <i class="fas fa-plus"></i> Yeni Üreme Kaydı
            </a>
        </div>
        <div class="card-body">
            {% if reproduction_records %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tohumlama Tarihi</th>
                            <th>Tohumlama Tipi</th>
                            <th>Durumu</th>
                            <th>Tahmini Doğum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in reproduction_records %}
                        <tr>
                            <td>{{ record.insemination_date|default:"Tarih Yok" }}</td>
                            <td>{{ record.get_insemination_type_display }}</td>
                            <td>
                                {% if record.pregnancy_status == 'pregnant' %}
                                <span class="badge bg-success">Gebe</span>
                                {% elif record.pregnancy_status == 'not_pregnant' %}
                                <span class="badge bg-danger">Gebe Değil</span>
                                {% elif record.pregnancy_status == 'miscarriage' %}
                                <span class="badge bg-warning text-dark">Düşük</span>
                                {% elif record.pregnancy_status == 'birth_completed' %}
                                <span class="badge bg-info">Doğum Yaptı</span>
                                {% else %}
                                <span class="badge bg-secondary">Bilinmiyor</span>
                                {% endif %}
                            </td>
                            <td>{% if record.expected_birth_date %}{{ record.expected_birth_date }}{% else %}-{% endif %}</td>
                            <td>
                                {% if record.pregnancy_status == 'pregnant' %}
                                <a href="{% url 'hayvan:birth_record_create' animal.pk record.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-baby"></i> Doğum Ekle
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted my-3">Henüz üreme kaydı bulunmamaktadır.</p>
            {% endif %}
        </div>
    </div>

    <!-- Doğum Kayıtları (Sadece Dişi Hayvanlar İçin) -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Doğum Kayıtları</h5>
            <a href="{% url 'hayvan:birth_record_create' animal.pk %}" class="btn btn-sm btn-success">
                <i class="fas fa-plus"></i> Yeni Doğum Kaydı
            </a>
        </div>
        <div class="card-body">
            {% if births %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Doğum Tarihi</th>
                            <th>Toplam Yavru</th>
                            <th>Erkek</th>
                            <th>Dişi</th>
                            <th>Ölü Doğum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for birth in births %}
                        <tr>
                            <td>{{ birth.birth_date }}</td>
                            <td>{{ birth.offspring_count }}</td>
                            <td>{{ birth.male_count }}</td>
                            <td>{{ birth.female_count }}</td>
                            <td>{{ birth.stillborn_count }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" disabled>
                                    <i class="fas fa-eye"></i> Detay
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted my-3">Henüz doğum kaydı bulunmamaktadır.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="col-md-6 col-lg-5">
        <!-- Sağlık İstatistikleri -->
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>İstatistikler</h5>
            </div>
            <div class="card-body">
                <h6 class="border-bottom pb-2 mb-3">Sağlık İstatistikleri</h6>
                <div class="row">
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Toplam Kayıt:</span>
                            <span class="fw-bold">{{ health_stats.total_records }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Son 12 Ay:</span>
                            <span class="fw-bold">{{ health_stats.recent_records }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Muayene:</span>
                            <span class="fw-bold">{{ health_stats.examination_count }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Aşı:</span>
                            <span class="fw-bold">{{ health_stats.vaccine_count }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Tedavi:</span>
                            <span class="fw-bold">{{ health_stats.treatment_count }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Ameliyat:</span>
                            <span class="fw-bold">{{ health_stats.surgery_count }}</span>
                        </div>
                    </div>
                    <div class="col-12 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Toplam Maliyet:</span>
                            <span class="fw-bold">{{ health_stats.total_cost|floatformat:2 }} TL</span>
                        </div>
                    </div>
                </div>
                
                {% if reproduction_stats %}
                <h6 class="border-bottom pb-2 mb-3 mt-4">Üreme İstatistikleri</h6>
                <div class="row">
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Tohumlama:</span>
                            <span class="fw-bold">{{ reproduction_stats.total_inseminations }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Doğum:</span>
                            <span class="fw-bold">{{ reproduction_stats.total_births }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Doğurganlık:</span>
                            <span class="fw-bold">{{ reproduction_stats.fertility_rate }}%</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Toplam Yavru:</span>
                            <span class="fw-bold">{{ reproduction_stats.total_offspring }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Erkek Yavru:</span>
                            <span class="fw-bold">{{ reproduction_stats.male_offspring }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Dişi Yavru:</span>
                            <span class="fw-bold">{{ reproduction_stats.female_offspring }}</span>
                        </div>
                    </div>
                    {% if reproduction_stats.next_expected_birth %}
                    <div class="col-12 mt-2">
                        <div class="alert alert-info py-2 mb-0">
                            <small>Tahmini Doğum: <strong>{{ reproduction_stats.next_expected_birth.expected_birth_date }}</strong></small>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Akraba Hayvanlar -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0"><i class="fas fa-sitemap me-2"></i>Akraba Hayvanlar</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% if related_animals.mother or related_animals.father %}
                    <div class="col-md-6 mb-3">
                        <h6 class="border-bottom pb-2 mb-3">Ebeveynler</h6>
                        <ul class="list-group list-group-flush">
                            {% if related_animals.mother %}
                                <li class="list-group-item px-0 py-2 border-0">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-danger me-2"><i class="fas fa-venus"></i></span>
                                        <div class="flex-grow-1">
                                            <strong>Anne:</strong> 
                                            <a href="{% url 'hayvan:animal_detail' related_animals.mother.pk %}" class="text-decoration-none">
                                                {{ related_animals.mother.tag_number }}
                                                {% if related_animals.mother.name %} - {{ related_animals.mother.name }}{% endif %}
                                            </a>
                                            <small class="text-muted d-block">{{ related_animals.mother.breed.name }} - {{ related_animals.mother.get_age }}</small>
                                        </div>
                                    </div>
                                </li>
                            {% else %}
                                <li class="list-group-item px-0 py-2 border-0 text-muted">
                                    <strong>Anne:</strong> 
                                    {% if animal.mother_tag_number %}
                                        {{ animal.mother_tag_number }} (Sistemde kayıtlı değil)
                                    {% else %}
                                        Bilgi yok
                                    {% endif %}
                                </li>
                            {% endif %}
                            
                            {% if related_animals.father %}
                                <li class="list-group-item px-0 py-2 border-0">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-primary me-2"><i class="fas fa-mars"></i></span>
                                        <div class="flex-grow-1">
                                            <strong>Baba:</strong> 
                                            <a href="{% url 'hayvan:animal_detail' related_animals.father.pk %}" class="text-decoration-none">
                                                {{ related_animals.father.tag_number }}
                                                {% if related_animals.father.name %} - {{ related_animals.father.name }}{% endif %}
                                            </a>
                                            <small class="text-muted d-block">{{ related_animals.father.breed.name }} - {{ related_animals.father.get_age }}</small>
                                        </div>
                                    </div>
                                </li>
                            {% else %}
                                <li class="list-group-item px-0 py-2 border-0 text-muted">
                                    <strong>Baba:</strong> 
                                    {% if animal.father_tag_number %}
                                        {{ animal.father_tag_number }} (Sistemde kayıtlı değil)
                                    {% else %}
                                        Bilgi yok
                                    {% endif %}
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                {% endif %}
                
                {% if animal.gender == 'F' and related_animals.offspring %}
                    <div class="col-md-6 mb-3">
                        <h6 class="border-bottom pb-2 mb-3">Yavrular</h6>
                        <ul class="list-group list-group-flush">
                            {% for offspring in related_animals.offspring %}
                                <li class="list-group-item px-0 py-2 border-0">
                                    <div class="d-flex align-items-center">
                                        <span class="badge {% if offspring.gender == 'M' %}bg-primary{% else %}bg-danger{% endif %} me-2">
                                            <i class="fas {% if offspring.gender == 'M' %}fa-mars{% else %}fa-venus{% endif %}"></i>
                                        </span>
                                        <div class="flex-grow-1">
                                            <strong>{{ offspring.tag_number }}</strong>
                                            {% if offspring.animal %}
                                                <a href="{% url 'hayvan:animal_detail' offspring.animal.pk %}" class="text-decoration-none">
                                                    {% if offspring.animal.name %} - {{ offspring.animal.name }}{% endif %}
                                                </a>
                                                <small class="text-muted d-block">{{ offspring.animal.breed.name }}</small>
                                            {% else %}
                                                <span class="text-muted">(Hayvan kaydı yok)</span>
                                            {% endif %}
                                        </div>
                                        <span class="text-muted">{{ offspring.birth.birth_date|date:"d.m.Y" }}</span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                {% if not related_animals.mother and not related_animals.father and not related_animals.offspring %}
                    <div class="col-12">
                        <div class="alert alert-info text-center mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Bu hayvan için kayıtlı akraba bulunmamaktadır.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Yem Tüketimi -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0"><i class="fas fa-utensils me-2"></i>Yem Tüketimi</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h3 class="display-4 mb-1">{{ feed_consumption.total|floatformat:1 }}</h3>
                        <p class="text-muted mb-0">Toplam Tüketim (kg)</p>
                        <small class="text-muted">Son {{ feed_consumption.period_days }} gün</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h3 class="display-4 mb-1">{{ feed_consumption.daily_avg|floatformat:1 }}</h3>
                        <p class="text-muted mb-0">Günlük Ortalama (kg)</p>
                        <small class="text-muted">Son {{ feed_consumption.period_days }} gün</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <a href="#" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-hamburger me-1"></i> Besleme Kaydı Ekle
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 